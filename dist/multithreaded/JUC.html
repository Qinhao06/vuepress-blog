<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CAS | Q&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="./logo-pork.png">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="./assets/css/0.styles.99c354d3.css" as="style"><link rel="preload" href="./assets/js/app.7da15c5d.js" as="script"><link rel="preload" href="./assets/js/7.2d1d063d.js" as="script"><link rel="preload" href="./assets/js/2.362395fa.js" as="script"><link rel="preload" href="./assets/js/1.7f08a6fc.js" as="script"><link rel="preload" href="./assets/js/57.324fe666.js" as="script"><link rel="prefetch" href="./assets/js/10.62b44cc9.js"><link rel="prefetch" href="./assets/js/11.5b4eff35.js"><link rel="prefetch" href="./assets/js/14.486c9707.js"><link rel="prefetch" href="./assets/js/15.7fe7c6f5.js"><link rel="prefetch" href="./assets/js/16.7a6ac2f2.js"><link rel="prefetch" href="./assets/js/17.47af578f.js"><link rel="prefetch" href="./assets/js/18.1e6a5ff3.js"><link rel="prefetch" href="./assets/js/19.516a4edf.js"><link rel="prefetch" href="./assets/js/20.3a15a40c.js"><link rel="prefetch" href="./assets/js/21.8c371842.js"><link rel="prefetch" href="./assets/js/22.d045e395.js"><link rel="prefetch" href="./assets/js/23.3b3722af.js"><link rel="prefetch" href="./assets/js/24.bcc64ae1.js"><link rel="prefetch" href="./assets/js/25.89c42b75.js"><link rel="prefetch" href="./assets/js/26.f0f82cc7.js"><link rel="prefetch" href="./assets/js/27.8943c5cf.js"><link rel="prefetch" href="./assets/js/28.446c390b.js"><link rel="prefetch" href="./assets/js/29.ccab773b.js"><link rel="prefetch" href="./assets/js/3.fba1493b.js"><link rel="prefetch" href="./assets/js/30.0f4fa488.js"><link rel="prefetch" href="./assets/js/31.391132c3.js"><link rel="prefetch" href="./assets/js/32.67359e38.js"><link rel="prefetch" href="./assets/js/33.43050dbf.js"><link rel="prefetch" href="./assets/js/34.60b471ab.js"><link rel="prefetch" href="./assets/js/35.65b0a44b.js"><link rel="prefetch" href="./assets/js/36.5e473810.js"><link rel="prefetch" href="./assets/js/37.8ec4160b.js"><link rel="prefetch" href="./assets/js/38.17c02484.js"><link rel="prefetch" href="./assets/js/39.7e1a9d84.js"><link rel="prefetch" href="./assets/js/4.4957128c.js"><link rel="prefetch" href="./assets/js/40.e1552a88.js"><link rel="prefetch" href="./assets/js/41.089e271d.js"><link rel="prefetch" href="./assets/js/42.356107a1.js"><link rel="prefetch" href="./assets/js/43.c14fd141.js"><link rel="prefetch" href="./assets/js/44.b8ca2586.js"><link rel="prefetch" href="./assets/js/45.8cbf0cfc.js"><link rel="prefetch" href="./assets/js/46.0c5bcfae.js"><link rel="prefetch" href="./assets/js/47.0fb1fd14.js"><link rel="prefetch" href="./assets/js/48.c2e004f3.js"><link rel="prefetch" href="./assets/js/49.6b769438.js"><link rel="prefetch" href="./assets/js/5.a45c296b.js"><link rel="prefetch" href="./assets/js/50.5297b778.js"><link rel="prefetch" href="./assets/js/51.00820c3b.js"><link rel="prefetch" href="./assets/js/52.29a50f28.js"><link rel="prefetch" href="./assets/js/53.93a7b90d.js"><link rel="prefetch" href="./assets/js/54.53781a52.js"><link rel="prefetch" href="./assets/js/55.37311893.js"><link rel="prefetch" href="./assets/js/56.57736d09.js"><link rel="prefetch" href="./assets/js/58.494dccb3.js"><link rel="prefetch" href="./assets/js/59.be51dfd5.js"><link rel="prefetch" href="./assets/js/6.ece4240a.js"><link rel="prefetch" href="./assets/js/60.fca80b33.js"><link rel="prefetch" href="./assets/js/61.9464aa21.js"><link rel="prefetch" href="./assets/js/62.929a842a.js"><link rel="prefetch" href="./assets/js/63.addad00a.js"><link rel="prefetch" href="./assets/js/64.76092c4c.js"><link rel="prefetch" href="./assets/js/65.ed2ef6d8.js"><link rel="prefetch" href="./assets/js/66.b72b68f4.js"><link rel="prefetch" href="./assets/js/67.9ae649dc.js"><link rel="prefetch" href="./assets/js/68.ca0d974b.js"><link rel="prefetch" href="./assets/js/69.de78ff2c.js"><link rel="prefetch" href="./assets/js/70.cc5c8152.js"><link rel="prefetch" href="./assets/js/71.bd843ada.js"><link rel="prefetch" href="./assets/js/8.975ef317.js"><link rel="prefetch" href="./assets/js/9.f2573e9b.js"><link rel="prefetch" href="./assets/js/vendors~docsearch.535306fc.js">
    <link rel="stylesheet" href="./assets/css/0.styles.99c354d3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Q's Blog</h3> <p class="description" data-v-59e6cb88>Just playing around</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>QH</span>
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><img src="./logo-pork.png" alt="Q's Blog" class="logo"> <span class="site-name">Q's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./" class="nav-link"><i class="undefined"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      学习过的一点点东西🤏
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./multithreaded/.html" class="nav-link"><i class="undefined"></i>
  java
</a></li><li class="dropdown-item"><!----> <a href="/./multithreaded/.html" class="nav-link"><i class="undefined"></i>
  go
</a></li><li class="dropdown-item"><!----> <a href="/./multithreaded/.html" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/./multithreaded/.html" class="nav-link"><i class="undefined"></i>
  vue
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Qinhao06" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="./logo-pork.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    QH
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>31</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>1</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/./" class="nav-link"><i class="undefined"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      学习过的一点点东西🤏
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./multithreaded/.html" class="nav-link"><i class="undefined"></i>
  java
</a></li><li class="dropdown-item"><!----> <a href="/./multithreaded/.html" class="nav-link"><i class="undefined"></i>
  go
</a></li><li class="dropdown-item"><!----> <a href="/./multithreaded/.html" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/./multithreaded/.html" class="nav-link"><i class="undefined"></i>
  vue
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Qinhao06" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span> Java多线程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./multithreaded/JUC.html" aria-current="page" class="active sidebar-link">JUC</a></li><li><a href="/./multithreaded/lock.html" class="sidebar-link">锁</a></li><li><a href="/./multithreaded/Synchronized.html" class="sidebar-link">Synchronized关键字</a></li><li><a href="/./multithreaded/Volatile.html" class="sidebar-link">Volatile关键字</a></li><li><a href="/./multithreaded/multithreadingLearning.html" class="sidebar-link">java 多线程学习</a></li><li><a href="/./multithreaded/polymorphicUnderlyingImplementation.html" class="sidebar-link">java 多态底层实现</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java分布式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java架构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mybatis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mysql</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tomcat</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>QH</span>
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">CAS</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>QH</span></i> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="cas"><a href="#cas" class="header-anchor">#</a> CAS</h1> <p>​	CAS-&gt;Compare and Swap，对比交换。</p> <p>需要输入两个数值，旧值和新值，当旧值在操作期间没有改变的时候更换成新值。</p> <p>实现方式为乐观锁，相对 synchronized 的悲观锁通常性能更优。</p> <p>存在问题：</p> <p>ABA 问题：如果一个值原来是A，变成了B，又变成了A，那么使用CAS进行检查时则会发现它的值没有发生变化，但是实际上却变化了。 可以通过版本号来解决。JDK 中的 Atomic 包中的AtomicStampedReference会检查标志。</p> <p>循环时间长开销大：自旋 CAS 长时间不成功。如果JVM能支持处理器提供的pause指令，那么效率会有一定的提升。pause指令有两个作用：第一，它可以延迟流水线执行命令(de-pipeline)，使CPU不会消耗过多的执行资源，延迟的时间取决于具体实现的版本，在一些处理器上延迟时间是零；第二，它可以避免在退出循环的时候因内存顺序冲突(Memory Order Violation)而引起CPU流水线被清空(CPU Pipeline Flush)，从而提高CPU的执行效率。</p> <p>只能保证一个共享变量的原子操作： 可以合并多个原子变量到一个 CAS 操作中。</p> <h1 id="unsafe-类"><a href="#unsafe-类" class="header-anchor">#</a> unsafe 类</h1> <p>Unsafe是位于sun.misc包下的一个类，主要提供一些用于执行低级别、不安全操作的方法，如直接访问系统内存资源、自主管理内存资源等，这些方法在提升Java运行效率、增强Java语言底层资源操作能力方面起到了很大的作用。一般是不对外开放的。</p> <p><img src="https://pdai.tech/images/thread/java-thread-x-atomicinteger-unsafe.png" alt="img"></p> <h1 id="常用的原子类"><a href="#常用的原子类" class="header-anchor">#</a> 常用的原子类</h1> <h3 id="atomicinterger"><a href="#atomicinterger" class="header-anchor">#</a> AtomicInterger</h3> <div class="language- extra-class"><pre class="language-text"><code>publicfinalintget()：获取当前的值 publicfinalintgetAndSet(int newValue)：获取当前的值，并设置新的值 publicfinalintgetAndIncrement()：获取当前的值，并自增 publicfinalintgetAndDecrement()：获取当前的值，并自减 publicfinalintgetAndAdd(int delta)：获取当前的值，并加上预期的值 voidlazySet(int newValue): 最终会设置成newValue,使用lazySet设置值后，可能导致其他线程在之后的一小段时间内还是可以读到旧值
</code></pre></div><p>​	底层使用 CAS，volatile 来实现。</p> <ul><li>AtomicBoolean: 原子更新布尔类型。</li> <li>AtomicInteger: 原子更新整型。</li> <li>AtomicLong: 原子更新长整型。</li> <li>AtomicIntegerArray: 原子更新整型数组里的元素。</li> <li>AtomicLongArray: 原子更新长整型数组里的元素。</li> <li>AtomicReferenceArray: 原子更新引用类型数组里的元素。</li> <li>AtomicReference: 原子更新引用类型。</li> <li>AtomicStampedReference: 原子更新引用类型, 内部使用Pair来存储元素值及其版本号。</li> <li>AtomicMarkableReferce: 原子更新带有标记位的引用类型。</li> <li>AtomicIntegerFieldUpdater: 原子更新整型的字段的更新器。</li> <li>AtomicLongFieldUpdater: 原子更新长整型字段的更新器。</li> <li>AtomicReferenceFieldUpdater: 原子更新引用字段的更新器</li></ul> <h1 id="juc锁"><a href="#juc锁" class="header-anchor">#</a> JUC锁</h1> <h3 id="locksupport"><a href="#locksupport" class="header-anchor">#</a> LockSupport</h3> <p>LockSupport用来创建锁和其他同步类的基本线程阻塞原语。简而言之，当调用LockSupport.park时，表示当前线程将会等待，直至获得许可，当调用LockSupport.unpark时，必须把等待获得许可的线程作为参数进行传递，好让此线程继续运行.</p> <p>底层是基于Unsafe 类中的 park 和 unpark 函数. 相对于使用 wait 和 notify，并不会因为调用顺序不当引起阻塞。可以先调用 unpark，仍能对后调用的park 有效果。</p> <h3 id="abstractqueuedsynchronizer"><a href="#abstractqueuedsynchronizer" class="header-anchor">#</a> AbstractQueuedSynchronizer</h3> <p>AQS是一个用来构建锁和同步器的框架，使用AQS能简单且高效地构造出应用广泛的大量的同步器，比如我们提到的ReentrantLock，Semaphore，其他的诸如ReentrantReadWriteLock，SynchronousQueue，FutureTask等等皆是基于AQS的。当然，我们自己也能利用AQS非常轻松容易地构造出符合我们自己需求的同步器。</p> <p>AQS核心思想是，如果被请求的共享资源空闲，则将当前请求资源的线程设置为有效的工作线程，并且将共享资源设置为锁定状态。如果被请求的共享资源被占用，那么就需要一套线程阻塞等待以及被唤醒时锁分配的机制，这个机制AQS是用CLH队列锁实现的，即将暂时获取不到锁的线程加入到队列中。</p> <p>CLH(Craig,Landin,and Hagersten)队列是一个虚拟的双向队列(虚拟的双向队列即不存在队列实例，仅存在结点之间的关联关系)。AQS是将每条请求共享资源的线程封装成一个CLH锁队列的一个结点(Node)来实现锁的分配。</p> <p><img src="https://s2.loli.net/2023/11/24/S5ZhNF9CO3TKwVW.png" alt="image-20231124103238469"></p> <h3 id="reentrantlock"><a href="#reentrantlock" class="header-anchor">#</a> ReentrantLock</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span>
</code></pre></div><p><img src="https://s2.loli.net/2023/11/24/Hv3bAk61p7KWlSG.png" alt="image"></p> <p>NonfairSync与FairSync类继承自Sync类，Sync类继承自AbstractQueuedSynchronizer抽象类。</p> <h3 id="reentrantreadwritelock"><a href="#reentrantreadwritelock" class="header-anchor">#</a> ReentrantReadWriteLock</h3> <p>ReentrantReadWriteLock表示可重入读写锁，ReentrantReadWriteLock中包含了两种锁，读锁ReadLock和写锁WriteLock，可以通过这两种锁实现线程间的同步</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantReadWriteLock</span> <span class="token keyword">implements</span> <span class="token class-name">ReadWriteLock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p><img src="https://s2.loli.net/2023/11/24/sLncQb2kdAxp8eI.png" alt="img"></p> <p>有一个写锁和读锁。</p> <h3 id="concurrenthashmap"><a href="#concurrenthashmap" class="header-anchor">#</a> ConcurrentHashMap</h3> <p>线程安全的 HashMap</p> <p>相对于 Hashtable 来说效率更快，这是因为 HashTable 实现使用了Synchronied关键字锁死哈希表。</p> <p>而ConcurrentHashMap在 JDK1.7 中使用了分段锁--将一个 hash 表分为多个Segmnet，每个表类似于一个 HashTable。</p> <h3 id="copyonwritearraylist"><a href="#copyonwritearraylist" class="header-anchor">#</a> CopyOnWriteArrayList</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> classCopyOnWriteArrayList<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">RandomAccess</span><span class="token punctuation">,</span><span class="token class-name">Cloneable</span><span class="token punctuation">,</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>CopyOnWriteArrayList是ArrayList 的一个线程安全的变体，其中所有可变操作(add、set 等等)都是通过对底层数组进行一次新的拷贝来实现的。COW模式的体现</p> <p>CopyOnWriteArrayList实现了List接口，List接口定义了对列表的基本操作；同时实现了RandomAccess接口，表示可以随机访问(数组具有随机访问的特性)；同时实现了Cloneable接口，表示可克隆；同时也实现了Serializable接口，表示可被序列化</p> <h3 id="concurrentlinkedqueue"><a href="#concurrentlinkedqueue" class="header-anchor">#</a> ConcurrentLinkedQueue</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>ConcurerntLinkedQueue一个基于链接节点的无界线程安全队列。此队列按照 FIFO(先进先出)原则对元素进行排序。队列的头部是队列中时间最长的元素。队列的尾部 是队列中时间最短的元素。新的元素插入到队列的尾部，队列获取操作从队列头部获得元素。当多个线程共享访问一个公共 collection 时，ConcurrentLinkedQueue是一个恰当的选择。此队列不允许使用null元素。</p> <p><img src="https://s2.loli.net/2023/11/24/ML8o4Fj6k73VX9h.png" alt="img"></p> <h3 id="blockingqueue"><a href="#blockingqueue" class="header-anchor">#</a> BlockingQueue</h3> <p>BlockingQueue 通常用于一个线程生产对象，而另外一个线程消费这些对象的场景。下图是对这个原理的阐述</p> <p><img src="https://s2.loli.net/2023/11/24/TFHWt7cNmyIaoMp.png" alt="img"></p> <p>一个线程往里边放，另外一个线程从里边取的一个 BlockingQueue。</p> <p>一个线程将会持续生产新对象并将其插入到队列之中，直到队列达到它所能容纳的临界点。也就是说，它是有限的。如果该阻塞队列到达了其临界点，负责生产的线程将会在往里边插入新对象时发生阻塞。它会一直处于阻塞之中，直到负责消费的线程从队列中拿走一个对象。 负责消费的线程将会一直从该阻塞队列中拿出对象。如果消费线程尝试去从一个空的队列中提取对象的话，这个消费线程将会处于阻塞之中，直到一个生产线程把一个对象丢进队列。</p> <p>BlockingQueue 具有 4 组不同的方法用于插入、移除以及对队列中的元素进行检查。如果请求的操作不能得到立即执行的话，每个方法的表现也不同。这些方法如下:</p> <table><thead><tr><th></th> <th>抛异常</th> <th>特定值</th> <th>阻塞</th> <th>超时</th></tr></thead> <tbody><tr><td>插入</td> <td>add(o)</td> <td>offer(o)</td> <td>put(o)</td> <td>offer(o, timeout, timeunit)</td></tr> <tr><td>移除</td> <td>remove()</td> <td>poll()</td> <td>take()</td> <td>poll(timeout, timeunit)</td></tr> <tr><td>检查</td> <td>element()</td> <td>peek()</td> <td></td> <td></td></tr></tbody></table> <p>抛异常: 如果试图的操作无法立即执行，抛一个异常。</p> <p>特定值: 如果试图的操作无法立即执行，返回一个特定的值(常常是 true / false)。</p> <p>阻塞: 如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行。</p> <p>超时: 如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行，但等待时间不会超过给定值。返回一个特定值以告知该操作是否成功(典型的是 true / false)。</p> <h3 id="blockingdeque"><a href="#blockingdeque" class="header-anchor">#</a> BlockingDeque</h3> <p>BlockingDeque 类是一个双端队列，在不能够插入元素时，它将阻塞住试图插入元素的线程；在不能够抽取元素时，它将阻塞住试图抽取的线程。 deque(双端队列) 是 &quot;Double Ended Queue&quot; 的缩写。因此，双端队列是一个你可以从任意一端插入或者抽取元素的队列。</p> <p>在线程既是一个队列的生产者又是这个队列的消费者的时候可以使用到 BlockingDeque。如果生产者线程需要在队列的两端都可以插入数据，消费者线程需要在队列的两端都可以移除数据，这个时候也可以使用 BlockingDeque。BlockingDeque 图解:</p> <p><img src="https://s2.loli.net/2023/11/24/XzRG7Fdc2wESCT6.png" alt="img"></p> <p>BlockingDeque 具有 4 组不同的方法用于插入、移除以及对双端队列中的元素进行检查。如果请求的操作不能得到立即执行的话，每个方法的表现也不同。这些方法如下:</p> <table><thead><tr><th></th> <th>抛异常</th> <th>特定值</th> <th>阻塞</th> <th>超时</th></tr></thead> <tbody><tr><td>插入</td> <td>addFirst(o)</td> <td>offerFirst(o)</td> <td>putFirst(o)</td> <td>offerFirst(o, timeout, timeunit)</td></tr> <tr><td>移除</td> <td>removeFirst(o)</td> <td>pollFirst(o)</td> <td>takeFirst(o)</td> <td>pollFirst(timeout, timeunit)</td></tr> <tr><td>检查</td> <td>getFirst(o)</td> <td>peekFirst(o)</td> <td></td> <td></td></tr></tbody></table> <table><thead><tr><th></th> <th>抛异常</th> <th>特定值</th> <th>阻塞</th> <th>超时</th></tr></thead> <tbody><tr><td>插入</td> <td>addLast(o)</td> <td>offerLast(o)</td> <td>putLast(o)</td> <td>offerLast(o, timeout, timeunit)</td></tr> <tr><td>移除</td> <td>removeLast(o)</td> <td>pollLast(o)</td> <td>takeLast(o)</td> <td>pollLast(timeout, timeunit)</td></tr> <tr><td>检查</td> <td>getLast(o)</td> <td>peekLast(o)</td> <td></td> <td></td></tr></tbody></table> <p>四组不同的行为方式解释:</p> <ul><li>抛异常: 如果试图的操作无法立即执行，抛一个异常。</li> <li>特定值: 如果试图的操作无法立即执行，返回一个特定的值(常常是 true / false)。</li> <li>阻塞: 如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行。</li> <li>超时: 如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行，但等待时间不会超过给定值。返回一个特定值以告知该操作是否成功(典型的是 true / false)。</li></ul> <h3 id="futuretask"><a href="#futuretask" class="header-anchor">#</a> FutureTask</h3> <p>FutureTask是一个可取消的异步计算，它实现了Future的基本方法，可以查询计算是否已经完成，并且可以获取计算的结果。FutureTask实现了Runnable接口，因此可以被提交给一个Executor执行。FutureTask多用于异步获取执行结果或取消执行任务的场景。它是一种可以取消的异步的计算任务，其计算是通过Callable实现的，等价于可以携带结果的Runnable。FutureTask有三个状态：等待、运行和完成。完成包括所有计算以任意的方式结束，包括正常结束、取消和异常。FutureTask 的线程安全由CAS来保证。</p> <p><img src="https://s2.loli.net/2023/11/25/szRe1uJ3WV2b9I4.png" alt="img"></p> <p>Callable 接口：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token comment">/**     * Computes a result, or throws an exception if unable to do so.     *     * @return computed result     * @throws Exception if unable to compute a result     */</span>
  <span class="token class-name">V</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre></div><p>Future接口</p> <p>Future接口代表异步计算的结果，通过Future接口提供的方法可以查看异步计算是否执行完成，或者等待执行结果并获取执行结果，同时还可以取消执行。Future接口的定义如下:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> mayInterruptIfRunning<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>
    <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>cancel()</code>:cancel()方法用来取消异步任务的执行。如果异步任务已经完成或者已经被取消，或者由于某些原因不能取消，则会返回false。如果任务还没有被执行，则会返回true并且异步任务不会被执行。如果任务已经开始执行了但是还没有执行完成，若mayInterruptIfRunning为true，则会立即中断执行任务的线程并返回true，若mayInterruptIfRunning为false，则会返回true且不会中断任务执行线程。</li> <li><code>isCanceled()</code>:判断任务是否被取消，如果任务在结束(正常执行结束或者执行异常结束)前被取消则返回true，否则返回false。</li> <li><code>isDone()</code>:判断任务是否已经完成，如果完成则返回true，否则返回false。需要注意的是：任务执行过程中发生异常、任务被取消也属于任务已完成，也会返回true。</li> <li><code>get()</code>:获取任务执行结果，如果任务还没完成则会阻塞等待直到任务执行完成。如果任务被取消则会抛出CancellationException异常，如果任务执行过程发生异常则会抛出ExecutionException异常，如果阻塞等待过程中被中断则会抛出InterruptedException异常。</li> <li><code>get(long timeout,Timeunit unit)</code>:带超时时间的get()版本，如果阻塞等待过程中超时则会抛出TimeoutException异常。</li></ul> <p>核心属性</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//内部持有的callable任务，运行完毕后置空</span>
<span class="token keyword">private</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">;</span>

<span class="token comment">//从get()中返回的结果或抛出的异常</span>
<span class="token keyword">private</span> <span class="token class-name">Object</span> outcome<span class="token punctuation">;</span> <span class="token comment">// non-volatile, protected by state reads/writes</span>

<span class="token comment">//运行callable的线程</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> runner<span class="token punctuation">;</span>

<span class="token comment">//使用Treiber栈保存等待线程</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">WaitNode</span> waiters<span class="token punctuation">;</span>

<span class="token comment">//任务状态</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NEW</span>          <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COMPLETING</span>   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NORMAL</span>       <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">EXCEPTIONAL</span>  <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANCELLED</span>    <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERRUPTING</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERRUPTED</span>  <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
</code></pre></div><p>其中需要注意的是state是volatile类型的，也就是说只要有任何一个线程修改了这个变量，那么其他所有的线程都会知道最新的值。7种状态具体表示：</p> <ul><li><code>NEW</code>:表示是个新的任务或者还没被执行完的任务。这是初始状态。</li> <li><code>COMPLETING</code>:任务已经执行完成或者执行任务的时候发生异常，但是任务执行结果或者异常原因还没有保存到outcome字段(outcome字段用来保存任务执行结果，如果发生异常，则用来保存异常原因)的时候，状态会从NEW变更到COMPLETING。但是这个状态会时间会比较短，属于中间状态。</li> <li><code>NORMAL</code>:任务已经执行完成并且任务执行结果已经保存到outcome字段，状态会从COMPLETING转换到NORMAL。这是一个最终态。</li> <li><code>EXCEPTIONAL</code>:任务执行发生异常并且异常原因已经保存到outcome字段中后，状态会从COMPLETING转换到EXCEPTIONAL。这是一个最终态。</li> <li><code>CANCELLED</code>:任务还没开始执行或者已经开始执行但是还没有执行完成的时候，用户调用了cancel(false)方法取消任务且不中断任务执行线程，这个时候状态会从NEW转化为CANCELLED状态。这是一个最终态。</li> <li><code>INTERRUPTING</code>: 任务还没开始执行或者已经执行但是还没有执行完成的时候，用户调用了cancel(true)方法取消任务并且要中断任务执行线程但是还没有中断任务执行线程之前，状态会从NEW转化为INTERRUPTING。这是一个中间状态。</li> <li><code>INTERRUPTED</code>:调用interrupt()中断任务执行线程之后状态会从INTERRUPTING转换到INTERRUPTED。这是一个最终态。 有一点需要注意的是，所有值大于COMPLETING的状态都表示任务已经执行完成(任务正常执行完成，任务执行异常或者任务被取消)。</li></ul> <p><img src="https://s2.loli.net/2023/11/25/NoQ95npPtOBfi7j.png" alt="img"></p> <h3 id="threadpoolexecutor"><a href="#threadpoolexecutor" class="header-anchor">#</a> ThreadPoolExecutor</h3> <p>线程池能够对线程进行统一分配，调优和监控:</p> <ul><li>降低资源消耗(线程无限制地创建，然后使用完毕后销毁)</li> <li>提高响应速度(无须创建线程)</li> <li>提高线程的可管理性</li></ul> <p><img src="https://s2.loli.net/2023/11/25/qz4RAQ8sGxEmOMg.png" alt=""></p> <h3 id="execute原理"><a href="#execute原理" class="header-anchor">#</a> Execute原理</h3> <p>当一个任务提交至线程池之后:</p> <ol><li>线程池首先当前运行的线程数量是否少于corePoolSize。如果是，则创建一个新的工作线程来执行任务。如果都在执行任务，则进入2.</li> <li>判断BlockingQueue是否已经满了，倘若还没有满，则将线程放入BlockingQueue。否则进入3.</li> <li>如果创建一个新的工作线程将使当前运行的线程数量超过maximumPoolSize，则交给RejectedExecutionHandler来处理任务。</li></ol> <p>当ThreadPoolExecutor创建新线程时，通过CAS来更新线程池的状态ctl.</p> <p>参数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                              <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                              <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                              <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span>
</code></pre></div><ul><li><code>corePoolSize</code> 线程池中的核心线程数，当提交一个任务时，线程池创建一个新线程执行任务，直到当前线程数等于corePoolSize, 即使有其他空闲线程能够执行新来的任务, 也会继续创建线程；如果当前线程数为corePoolSize，继续提交的任务被保存到阻塞队列中，等待被执行；如果执行了线程池的prestartAllCoreThreads()方法，线程池会提前创建并启动所有核心线程。</li> <li><code>workQueue</code> 用来保存等待被执行的任务的阻塞队列.
<ul><li><code>ArrayBlockingQueue</code>: 基于数组结构的有界阻塞队列，按FIFO排序任务；</li> <li><code>LinkedBlockingQueue</code>: 基于链表结构的阻塞队列，按FIFO排序任务，吞吐量通常要高于ArrayBlockingQueue；</li> <li><code>SynchronousQueue</code>: 一个不存储元素的阻塞队列，每个插入操作必须等到另一个线程调用移除操作，否则插入操作一直处于阻塞状态，吞吐量通常要高于LinkedBlockingQueue；</li> <li><code>PriorityBlockingQueue</code>: 具有优先级的无界阻塞队列；</li></ul></li></ul> <p><code>LinkedBlockingQueue</code>比<code>ArrayBlockingQueue</code>在插入删除节点性能方面更优，但是二者在<code>put()</code>, <code>take()</code>任务的时均需要加锁，<code>SynchronousQueue</code>使用无锁算法，根据节点的状态判断执行，而不需要用到锁，其核心是<code>Transfer.transfer()</code>.</p> <ul><li><code>maximumPoolSize</code> 线程池中允许的最大线程数。如果当前阻塞队列满了，且继续提交任务，则创建新的线程执行任务，前提是当前线程数小于maximumPoolSize；当阻塞队列是无界队列, 则maximumPoolSize则不起作用, 因为无法提交至核心线程池的线程会一直持续地放入workQueue.</li> <li><code>keepAliveTime</code> 线程空闲时的存活时间，即当线程没有任务执行时，该线程继续存活的时间；默认情况下，该参数只在线程数大于corePoolSize时才有用, 超过这个时间的空闲线程将被终止；</li> <li><code>unit</code> keepAliveTime的单位</li> <li><code>threadFactory</code> 创建线程的工厂，通过自定义的线程工厂可以给每个新建的线程设置一个具有识别度的线程名。默认为DefaultThreadFactory</li> <li><code>handler</code> 线程池的饱和策略，当阻塞队列满了，且没有空闲的工作线程，如果继续提交任务，必须采取一种策略处理该任务，线程池提供了4种策略:
<ul><li><code>AbortPolicy</code>: 直接抛出异常，默认策略；</li> <li><code>CallerRunsPolicy</code>: 用调用者所在的线程来执行任务；</li> <li><code>DiscardOldestPolicy</code>: 丢弃阻塞队列中靠最前的任务，并执行当前任务；</li> <li><code>DiscardPolicy</code>: 直接丢弃任务；</li></ul></li></ul> <p>当然也可以根据应用场景实现RejectedExecutionHandler接口，自定义饱和策略，如记录日志或持久化存储不能处理的任务</p> <p><img src="https://s2.loli.net/2023/11/25/rjt5bskRl6fciDG.png" alt="img"></p> <h3 id="scheduledthreadpoolexecutor"><a href="#scheduledthreadpoolexecutor" class="header-anchor">#</a> ScheduledThreadPoolExecutor</h3> <p>ScheduledThreadPoolExecutor继承自 ThreadPoolExecutor，为任务提供延迟或周期执行，属于线程池的一种。和 ThreadPoolExecutor 相比，它还具有以下几种特性:</p> <ul><li>使用专门的任务类型—ScheduledFutureTask 来执行周期任务，也可以接收不需要时间调度的任务(这些任务通过 ExecutorService 来执行)。</li> <li>使用专门的存储队列—DelayedWorkQueue 来存储任务，DelayedWorkQueue 是无界延迟队列DelayQueue 的一种。相比ThreadPoolExecutor也简化了执行机制(delayedExecute方法，后面单独分析)。</li> <li>支持可选的run-after-shutdown参数，在池被关闭(shutdown)之后支持可选的逻辑来决定是否继续运行周期或延迟任务。并且当任务(重新)提交操作与 shutdown 操作重叠时，复查逻辑也不相同。</li></ul> <p><img src="https://s2.loli.net/2023/11/25/KehEw4moOi6YlDj.png" alt="img"></p> <h3 id="fork-join框架"><a href="#fork-join框架" class="header-anchor">#</a> Fork/Join框架</h3> <p>Fork/Join框架是Java中用于并行执行任务的框架，其基本思路是将一个较大的任务划分成若干个逻辑相同的子任务并发执行。这些子任务会递归地分解为更小的子任务，直到它们足够简单以便异步执行。然后，这些子任务的结果会被汇总起来，最终得到原始任务的结果。</p> <p>Fork/Join框架的核心类包括ForkJoinTask、ForkJoinPool和RecursiveAction等。ForkJoinTask是Fork/Join框架任务的抽象父类，它定义了fork()和join()方法，分别处理线程的拆分和结果的合并。ForkJoinPool是用于执行ForkJoinTask的线程池，它通过使用少量的线程来处理大量的任务，特别适合处理CPU密集型任务。RecursiveAction是ForkJoinTask的子类，用于表示可递归执行的任务。</p> <p>在Fork/Join框架中，任务是递归地进行拆分和执行的，这种分治算法类似于归并排序、快速排序等算法。通过将大任务拆分成小任务，并并发执行，Fork/Join框架能够有效地利用多核CPU的优势，提高程序的执行效率。同时，由于每个子任务都是独立的，因此也可以很好地解决线程同步问题。</p> <p><img src="https://s2.loli.net/2023/11/25/8rSWyn27ktpN4R6.png" alt="img"></p> <p>上图可以看出ForkJoinPool 中的任务执行分两种:</p> <ul><li>直接通过 FJP 提交的外部任务(external/submissions task)，存放在 workQueues 的偶数槽位；</li> <li>通过内部 fork 分割的子任务(Worker task)，存放在 workQueues 的奇数槽位</li></ul> <p><img src="https://s2.loli.net/2023/11/25/Gu1mEPRYqrwMKIb.png" alt="img"></p> <p>以下是一个使用Fork/Join框架的简单示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">RecursiveAction</span></span><span class="token punctuation">;</span>  
  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ForkJoinExample</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveAction</span> <span class="token punctuation">{</span>  
    <span class="token keyword">private</span> <span class="token keyword">int</span> start<span class="token punctuation">;</span>  
    <span class="token keyword">private</span> <span class="token keyword">int</span> end<span class="token punctuation">;</span>  
  
    <span class="token keyword">public</span> <span class="token class-name">ForkJoinExample</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">int</span> length <span class="token operator">=</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果长度小于等于100，直接计算结果  </span>
            <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                sum <span class="token operator">+=</span> i<span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 如果长度大于100，拆分任务并执行子任务  </span>
            <span class="token keyword">int</span> middle <span class="token operator">=</span> <span class="token punctuation">(</span>end <span class="token operator">+</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>  
            <span class="token class-name">ForkJoinExample</span> left <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinExample</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> middle<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token class-name">ForkJoinExample</span> right <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinExample</span><span class="token punctuation">(</span>middle <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            left<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拆分任务并执行子任务左半部分  </span>
            right<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拆分任务并执行子任务右半部分  </span>
            <span class="token comment">// 等待左右两个子任务执行完成并合并结果  </span>
            <span class="token keyword">int</span> leftResult <span class="token operator">=</span> left<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">int</span> rightResult <span class="token operator">=</span> right<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>leftResult <span class="token operator">+</span> rightResult<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 合并左右两个子任务的结果并输出  </span>
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token class-name">ForkJoinExample</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinExample</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个任务，起始值为1，结束值为1000  </span>
        example<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行该任务，会递归地执行子任务，直到计算出最终结果并输出到控制台  </span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>在这个示例中，我们创建了一个名为ForkJoinExample的类，它继承自RecursiveAction类，表示一个可以递归执行的任务。在构造函数中，我们传入了任务的起始值和结束值。在compute方法中，我们首先判断任务的长度是否小于等于100，如果是，则直接计算结果并输出；否则，我们将任务拆分成左右两个子任务，并分别创建左右两个子任务对象。然后，我们调用fork方法将左右两个子任务加入到线程池中并立即返回，表示这两个子任务已经准备好被执行。接着，我们调用join方法等待左右两个子任务执行完成并获取它们的结果。最后，我们将左右两个子任务的结果合并并输出最终结果。在main方法中，我们创建了一个ForkJoinExample对象，并调用fork方法开始执行该任务。由于该任务会递归地执行子任务，因此最终会计算出起始值为1到结束值为1000的所有整数的和并输出到控制台。</p> <h3 id="countdownlatch"><a href="#countdownlatch" class="header-anchor">#</a> CountDownLatch</h3> <p>CountDownLatch是一个同步工具类，用于协调多个线程之间的同步。它允许一个或多个线程在完成一组正在其他线程中执行的操作之前一直等待。</p> <p>CountDownLatch使用一个计数器进行实现，计数器的初始值就是线程的数量。每当一个被计数的线程完成任务后，计数器值减一；当计数器的值变为0时，表示所有线程都已经完成了任务，然后在CountDownLatch上等待的线程就可以恢复执行。</p> <p>CountDownLatch的主要用途是确保某个计算在其需要的所有资源都被初始化之后才继续执行，或者确保某个服务在其依赖的所有其他服务都已经启动之后才启动。它也可以用来等待直到某个操作所有参与者都准备就绪再继续执行。</p> <p>使用CountDownLatch的步骤包括：</p> <ol><li>初始化一个CountDownLatch对象，将计数器的初始值设置为需要等待的线程数量。</li> <li>在需要等待的线程中执行任务，并在任务完成后调用countDown()方法，将计数器减一。</li> <li>在需要等待的线程中调用await()方法，等待计数器达到0。如果计数器已经达到0，则该线程会继续执行；否则，该线程会被阻塞直到计数器达到0。</li></ol> <p>需要注意的是，CountDownLatch只能保证完成某个任务的先决条件满足，不能保证任务的结果正确性。如果需要保证任务结果的正确性，需要在程序中添加其他同步机制。</p> <p>以下是一个使用CountDownLatch的简单示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span></span><span class="token punctuation">;</span>  
  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatchExample</span> <span class="token punctuation">{</span>  
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>  
        <span class="token comment">// 创建一个CountDownLatch对象，初始值为3  </span>
        <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// 创建三个线程，分别执行任务并调用countDown()方法计数器减一  </span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
            <span class="token keyword">try</span> <span class="token punctuation">{</span>  
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread 1 completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
            <span class="token keyword">try</span> <span class="token punctuation">{</span>  
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread 2 completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token class-name">Thread</span> t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
            <span class="token keyword">try</span> <span class="token punctuation">{</span>  
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread 3 completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// 启动三个线程，并调用await()方法等待计数器达到0，即等待所有线程完成任务  </span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待所有线程完成任务  </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;All threads completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>在这个示例中，我们创建了一个CountDownLatch对象，初始值为3。然后创建了三个线程，分别执行任务并调用countDown()方法计数器减一。在主线程中，我们启动了三个线程并调用await()方法等待计数器达到0，即等待所有线程完成任务。当所有线程完成任务后，主线程会继续执行并输出&quot;All threads completed&quot;。</p> <h3 id="cyclicbarrier"><a href="#cyclicbarrier" class="header-anchor">#</a> CyclicBarrier</h3> <p>CyclicBarrier是一个Java中的同步工具类，可以用于让一组线程相互等待，只有当所有线程都到达某个屏障点后，所有线程才会同时继续执行。CyclicBarrier字面意思为循环栅栏，它是一个可循环利用的屏障，初始时规定一个数目，然后计算调用了CyclicBarrier.await()方法进入等待的线程数，当线程数达到了最初设定的数目时，所有进入等待状态的线程被唤醒并继续执行。CyclicBarrier内部维护了一个计数器（通过构造函数设置），用于记录等待的线程数量。每次有一个线程调用await()方法时，计数器加1；当计数器的值等于初始设定值时，所有在await()方法上等待的线程都被唤醒并继续执行。</p> <p>CyclicBarrier非常适合用于多线程协作的场景，可以确保所有线程都完成了某个阶段的工作后，再一起进入下一个阶段。它常用于并行计算、多线程数据分片、并发测试等场景。</p> <p>CyclicBarrier底层是基于ReentrantLock和AbstractQueuedSynchronizer来实现。</p> <h3 id="phaser"><a href="#phaser" class="header-anchor">#</a> Phaser</h3> <p>Phaser是Java中的一个并发工具类，用于实现多线程的同步和协作。它提供了一种简单而高效的方法来处理并发线程之间的同步问题。</p> <p>Phaser类中的主要方法是<code>register()</code>和<code>arrive()</code>。<code>register()</code>方法用于将Phaser实例与一个参与者的线程关联起来，而<code>arrive()</code>方法用于通知Phaser实例有一个参与者已经完成了自己的任务。</p> <p>当一个线程调用<code>arrive()</code>方法时，Phaser实例会检查当前已经完成的任务数是否等于初始注册的任务数。如果是，则Phaser实例会通知所有等待的线程，即已经到达了公共终点。这样，所有的参与者线程都可以继续执行后续的任务。</p> <p>通过使用Phaser，可以很容易地实现多个线程之间的同步和协作。它可以帮助开发者避免使用复杂的锁和其他同步机制，从而提高代码的可读性和性能。</p> <p>以下是一个简单的例子，展示了如何使用Phaser实现多个线程的同步：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Phaser</span></span><span class="token punctuation">;</span>  
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>  
  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhaserExample</span> <span class="token punctuation">{</span>  
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>  
        <span class="token keyword">int</span> numProcesses <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  
        <span class="token class-name">Phaser</span> phaser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phaser</span><span class="token punctuation">(</span>numProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numProcesses<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Process &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; is running&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token keyword">try</span> <span class="token punctuation">{</span>  
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模拟任务耗时  </span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span>  
                phaser<span class="token punctuation">.</span><span class="token function">arrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知Phaser有一个参与者已经完成任务  </span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
  
        phaser<span class="token punctuation">.</span><span class="token function">awaitAdvance</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待所有参与者到达公共终点  </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;All processes have completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的例子中，我们创建了一个包含5个参与者的Phaser实例。每个参与者线程会运行一个耗时1秒的任务，并在任务完成后调用<code>arrive()</code>方法通知Phaser。最后，我们调用<code>awaitAdvance(0)</code>方法来等待所有参与者到达公共终点，并输出一条消息表示所有进程已经完成。</p> <p>多阶段例子：</p> <p>Phaser 存在多个阶段，每个阶段都可以有不同的参与者和注册的线程。每个阶段由一个唯一的阶段编号标识，编号从0开始递增。</p> <p>要完成阶段间线程的注册等操作，可以按照以下步骤进行：</p> <ol><li>创建 Phaser 实例，并指定初始阶段数。例如，<code>Phaser phaser = new Phaser(numStages)</code>。</li> <li>在每个阶段中，调用 <code>register()</code> 方法来注册参与该阶段的线程。例如，<code>phaser.register(thread)</code>。</li> <li>在每个阶段中，调用 <code>arrive()</code> 方法来通知 Phaser 有一个参与者已经完成了该阶段的任务。例如，<code>phaser.arrive()</code>。</li> <li>在所有阶段都完成后，可以调用 <code>awaitAdvance()</code> 方法来等待所有参与者到达下一个阶段。例如，<code>phaser.awaitAdvance(nextStageNumber)</code>。</li> <li>重复步骤2到步骤4，直到所有阶段都完成。</li></ol> <p>下面是一个简单的例子，展示了如何使用 Phaser 完成多个阶段之间的线程注册和同步：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Phaser</span></span><span class="token punctuation">;</span>  
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>  
  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhaserExample</span> <span class="token punctuation">{</span>  
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>  
        <span class="token keyword">int</span> numStages <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 定义初始阶段数  </span>
        <span class="token class-name">Phaser</span> phaser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phaser</span><span class="token punctuation">(</span>numStages<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建 Phaser 实例  </span>
  
        <span class="token comment">// 第一个阶段  </span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numStages<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Stage &quot;</span> <span class="token operator">+</span> phaser<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; thread is running&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token keyword">try</span> <span class="token punctuation">{</span>  
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模拟任务耗时  </span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span>  
                phaser<span class="token punctuation">.</span><span class="token function">arrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知 Phaser 有一个参与者已经完成该阶段的任务  </span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
  
        <span class="token comment">// 等待所有线程到达下一个阶段  </span>
        phaser<span class="token punctuation">.</span><span class="token function">awaitAdvance</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// 第二个阶段  </span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numStages<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Stage &quot;</span> <span class="token operator">+</span> phaser<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; thread is running&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token keyword">try</span> <span class="token punctuation">{</span>  
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模拟任务耗时  </span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span>  
                phaser<span class="token punctuation">.</span><span class="token function">arrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知 Phaser 有一个参与者已经完成该阶段的任务  </span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
  
        <span class="token comment">// 等待所有线程到达下一个阶段  </span>
        phaser<span class="token punctuation">.</span><span class="token function">awaitAdvance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// 第三个阶段  </span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numStages<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Stage &quot;</span> <span class="token operator">+</span> phaser<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; thread is running&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token keyword">try</span> <span class="token punctuation">{</span>  
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模拟任务耗时  </span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span>  
                phaser<span class="token punctuation">.</span><span class="token function">arrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知 Phaser 有一个参与者已经完成该阶段的任务  </span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><h3 id="semaphore"><a href="#semaphore" class="header-anchor">#</a> Semaphore</h3> <p>在Java中，Semaphore是一个用于限制对共享资源访问的并发线程数的方法。它是一种计数器，可以用来控制对共享资源的访问次数。</p> <p>Semaphore维护了一个计数器，该计数器表示可用的许可证数量。每当一个线程需要访问共享资源时，它需要获取一个许可证。如果计数器为零，则线程将被阻塞，直到有一个许可证可用。当线程完成对共享资源的访问后，它会释放一个许可证，以便其他线程可以继续执行。</p> <p>Java中的Semaphore可以使用<code>java.util.concurrent.Semaphore</code>类来实现。该类提供了构造函数来初始化计数器，以及<code>acquire()</code>和<code>release()</code>方法来获取和释放许可证。</p> <p>下面是一个使用Semaphore来限制对共享资源访问的并发线程数的示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Semaphore</span></span><span class="token punctuation">;</span>  
  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SemaphoreExample</span> <span class="token punctuation">{</span>  
    <span class="token keyword">private</span> <span class="token class-name">Semaphore</span> semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 限制并发线程数为3  </span>
  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">try</span> <span class="token punctuation">{</span>  
            semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取一个许可证，如果没有可用则被阻塞  </span>
            <span class="token comment">// 执行对共享资源的访问  </span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>  
            semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放一个许可证，允许其他线程继续执行  </span>
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的示例中，Semaphore的初始计数器被设置为3，这意味着最多只能有3个线程同时访问共享资源。如果超过这个数量，其他线程将被阻塞，直到有一个许可证可用。当线程完成对共享资源的访问后，它会释放一个许可证，以便其他线程可以继续执行。</p> <h3 id="phaser-2"><a href="#phaser-2" class="header-anchor">#</a> Phaser</h3> <h3 id="exchanger"><a href="#exchanger" class="header-anchor">#</a> Exchanger</h3> <p>Exchanger是一个用于线程间协作的工具类，它提供了一个同步点，在这个同步点，两个线程可以交换彼此的数据。这种交换是只能在两个线程之间进行的，不支持更多的线程之间互换数据。当一个线程调用Exchange对象的exchange()方法后，它会陷入阻塞状态，直到另一个线程也调用了exchange()方法，然后以线程安全的方式交换数据。之后这两个线程继续运行。Exchanger的应用场景包括遗传算法和校对工作等。</p> <p>以下是一个使用Exchanger的例子：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExchangerExample</span> <span class="token punctuation">{</span>  
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token comment">// 创建Exchanger对象  </span>
        <span class="token class-name">Exchanger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exchanger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exchanger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// 创建两个线程T1和T2，它们共享同一个Exchanger对象  </span>
        <span class="token class-name">Thread</span> <span class="token constant">T1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token annotation punctuation">@Override</span>  
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token keyword">try</span> <span class="token punctuation">{</span>  
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; start.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token comment">// 随机休眠1~10秒钟  </span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token comment">// 执行exchange()方法，将字符串&quot;I am from T1&quot;传递给T2线程，并等待T2线程返回数据  </span>
                    <span class="token class-name">String</span> data <span class="token operator">=</span> exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token string">&quot;I am from T1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; received:&quot;</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;T1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token class-name">Thread</span> <span class="token constant">T2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token annotation punctuation">@Override</span>  
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token keyword">try</span> <span class="token punctuation">{</span>  
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; start.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token comment">// 随机休眠1~10秒钟  </span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token comment">// 执行exchange()方法，将字符串&quot;I am from T2&quot;传递给T1线程，并等待T1线程返回数据  </span>
                    <span class="token class-name">String</span> data <span class="token operator">=</span> exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token string">&quot;I am from T2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; received:&quot;</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;T2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// 启动T1和T2两个线程  </span>
        <span class="token constant">T1</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token constant">T2</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>在这个例子中，我们创建了一个Exchanger对象，并创建了两个线程T1和T2，它们共享同一个Exchanger对象。在每个线程的run方法中，我们使用Exchanger的exchange方法进行数据交换。T1线程将字符串&quot;I am from T1&quot;传递给T2线程，并等待T2线程返回数据；T2线程将字符串&quot;I am from T2&quot;传递给T1线程，并等待T1线程返回数据。当两个线程都到达同步点时，它们就可以交换数据，将本线程生产出来的数据传递给对方。</p> <h3 id="threadlocal"><a href="#threadlocal" class="header-anchor">#</a> ThreadLocal</h3> <p>ThreadLocal是Java中的一个类，它用来创建线程局部变量。线程局部变量是每个线程都有自己独立的一个变量副本，而这个副本对其他线程是不可见的。这意味着每一个线程都可以在不影响其他线程的情况下，修改自己的变量值。ThreadLocal的实例通常是在类中以静态字段的方式存在的。</p> <p>ThreadLocal的主要用途是为了在多线程环境下，为每个线程提供一个唯一的变量副本，以避免线程安全问题。因为每个线程都有自己独立的变量副本，所以每个线程可以操作自己的变量值，而不会影响其他线程的变量值。</p> <p>ThreadLocal的使用方式很简单。首先需要创建一个ThreadLocal实例，然后使用set方法将值存储在当前的线程中，每个线程都有自己独立的变量副本。当需要获取当前线程中的变量值时，可以使用get方法。如果需要清除当前线程中的变量副本，可以使用remove方法。</p> <p>下面是一个简单的示例代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalExample</span> <span class="token punctuation">{</span>  
    <span class="token comment">// 创建一个ThreadLocal实例  </span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token comment">// 在线程1中执行任务  </span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
            <span class="token comment">// 将值存储在当前的线程中  </span>
            threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread 1: &quot;</span> <span class="token operator">+</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// 在线程2中执行任务  </span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>  
            <span class="token comment">// 将值存储在当前的线程中  </span>
            threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread 2: &quot;</span> <span class="token operator">+</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的示例中，我们创建了一个ThreadLocal实例，并在两个不同的线程中分别存储了不同的值。每个线程都有自己独立的变量副本，因此它们不会互相干扰。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/./multithreaded/lock.html">
          锁
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#atomicinterger" class="sidebar-link reco-side-atomicinterger" data-v-b57cc07c>AtomicInterger</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#locksupport" class="sidebar-link reco-side-locksupport" data-v-b57cc07c>LockSupport</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#abstractqueuedsynchronizer" class="sidebar-link reco-side-abstractqueuedsynchronizer" data-v-b57cc07c>AbstractQueuedSynchronizer</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#reentrantlock" class="sidebar-link reco-side-reentrantlock" data-v-b57cc07c>ReentrantLock</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#reentrantreadwritelock" class="sidebar-link reco-side-reentrantreadwritelock" data-v-b57cc07c>ReentrantReadWriteLock</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#concurrenthashmap" class="sidebar-link reco-side-concurrenthashmap" data-v-b57cc07c>ConcurrentHashMap</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#copyonwritearraylist" class="sidebar-link reco-side-copyonwritearraylist" data-v-b57cc07c>CopyOnWriteArrayList</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#concurrentlinkedqueue" class="sidebar-link reco-side-concurrentlinkedqueue" data-v-b57cc07c>ConcurrentLinkedQueue</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#blockingqueue" class="sidebar-link reco-side-blockingqueue" data-v-b57cc07c>BlockingQueue</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#blockingdeque" class="sidebar-link reco-side-blockingdeque" data-v-b57cc07c>BlockingDeque</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#futuretask" class="sidebar-link reco-side-futuretask" data-v-b57cc07c>FutureTask</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#threadpoolexecutor" class="sidebar-link reco-side-threadpoolexecutor" data-v-b57cc07c>ThreadPoolExecutor</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#execute原理" class="sidebar-link reco-side-execute原理" data-v-b57cc07c>Execute原理</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#scheduledthreadpoolexecutor" class="sidebar-link reco-side-scheduledthreadpoolexecutor" data-v-b57cc07c>ScheduledThreadPoolExecutor</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#fork-join框架" class="sidebar-link reco-side-fork-join框架" data-v-b57cc07c>Fork/Join框架</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#countdownlatch" class="sidebar-link reco-side-countdownlatch" data-v-b57cc07c>CountDownLatch</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#cyclicbarrier" class="sidebar-link reco-side-cyclicbarrier" data-v-b57cc07c>CyclicBarrier</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#phaser" class="sidebar-link reco-side-phaser" data-v-b57cc07c>Phaser</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#semaphore" class="sidebar-link reco-side-semaphore" data-v-b57cc07c>Semaphore</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#phaser-2" class="sidebar-link reco-side-phaser-2" data-v-b57cc07c>Phaser</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#exchanger" class="sidebar-link reco-side-exchanger" data-v-b57cc07c>Exchanger</a></li><li class="level-3" data-v-b57cc07c><a href="/./multithreaded/JUC.html#threadlocal" class="sidebar-link reco-side-threadlocal" data-v-b57cc07c>ThreadLocal</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="cat-container" data-v-a13867c0><canvas id="vuepress-cat" width="280" height="250" class="live2d" data-v-a13867c0></canvas></div></div></div>
    <script src="./assets/js/app.7da15c5d.js" defer></script><script src="./assets/js/7.2d1d063d.js" defer></script><script src="./assets/js/2.362395fa.js" defer></script><script src="./assets/js/1.7f08a6fc.js" defer></script><script src="./assets/js/57.324fe666.js" defer></script>
  </body>
</html>
